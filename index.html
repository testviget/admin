
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ë–∞–ª–∞–Ω—Å</title>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #ffffff;
      display: flex;
      justify-content: center;
      margin-top: 40px;
    }
    .panel {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
      width: 400px;
    }
    .user-item {
      background: #2a2a2a;
      border: 1px solid #555;
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #ffc107;
      color: #000;
    }
    button:hover {
      background-color: #e0a800;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –±–∞–ª–∞–Ω—Å</h2>
    <div id="userList"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      'https://vhkouevuopjvsjpaxsyb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoa291ZXZ1b3BqdnNqcGF4c3liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTcxNDgsImV4cCI6MjA2NzQ5MzE0OH0.rle3WfPn1_aa5pKT53VJev19nOAM1msCRg0U7jLR9XI'
    );

    async function loadUsers() {
      const userList = document.getElementById("userList");
      userList.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

      const { data, error } = await supabase.from("users").select("*").order("balance", { ascending: false });

      if (error) {
        userList.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π";
        console.error(error);
        return;
      }

      if (data.length === 0) {
        userList.innerHTML = "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π";
        return;
      }

      userList.innerHTML = "";
      data.forEach(user => {
        const div = document.createElement("div");
        div.className = "user-item";
        div.innerHTML = `
          <div>
            <img src="${user.avatar}" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:10px;">
            <b>${user.name}</b><br>
            ID: ${user.id}<br>
            üí∞ –ë–∞–ª–∞–Ω—Å: <b>${(user.balance ?? 0).toLocaleString('ru-RU')}</b> –º–æ–Ω–µ—Ç
          </div>
          <button class="edit-balance-btn" data-id="${user.id}" data-balance="${(user.balance ?? 0).toLocaleString('ru-RU')}">üí≥ –ò–∑–º–µ–Ω–∏—Ç—å</button>
        `;
        userList.appendChild(div);
      });
    }

    loadUsers();
  </script>

  <div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.7);justify-content:center;align-items:center;">
    <div style="background:#2c2c2c;padding:20px;border-radius:10px;width:300px;">
      <h3>–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
      <p id="editUserInfo" style="margin-bottom:10px;"></p>
      <input id="newBalanceInput" type="number" placeholder="–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å" style="width:100%;padding:6px;border-radius:6px;border:none;" min="0">
      <button id="saveBalanceBtn" style="margin-top:10px;width:100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <script>
    let selectedUserId = null;

    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('edit-balance-btn')) {
  console.log('üü° –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID:', e.target.dataset.id);
        selectedUserId = e.target.dataset.id;
        const name = e.target.closest('.user-item').querySelector('b').textContent;
        const balance = e.target.dataset.balance;
        document.getElementById('editUserInfo').innerHTML = `<b>${name}</b><br>ID: ${selectedUserId}<br>–¢–µ–∫—É—â–∏–π: ${balance}`;
        document.getElementById('newBalanceInput').value = balance;
        document.getElementById('editModal').style.display = 'flex';
      }

      if (e.target.id === 'saveBalanceBtn') {
  console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–ª–∞–Ω—Å –¥–ª—è ID:', selectedUserId);
        const newBalance = parseInt(document.getElementById('newBalanceInput').value);
        if (isNaN(newBalance)) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
        const { error } = await window.supabase.from("users").update({ balance: newBalance }).eq("id", selectedUserId);
        if (error) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞');
          console.error(error);
        } else {
          
          document.getElementById('editModal').style.display = 'none';
          // üîÅ –û–±–Ω–æ–≤–∏–º –±–ª–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const { data: updatedUser } = await window.supabase
            .from("users")
            .select("*")
            .eq("id", selectedUserId)
            .single();

          if (updatedUser) {
            const userDivs = document.querySelectorAll('.user-item');
            userDivs.forEach(div => {
              const btn = div.querySelector('.edit-balance-btn');
              if (btn && btn.dataset.id === selectedUserId) {
                div.innerHTML = `
                  <div>
                    <img src="${updatedUser.avatar}" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:10px;">
                    <b>${updatedUser.name}</b><br>
                    ID: ${updatedUser.id}<br>
                    üí∞ –ë–∞–ª–∞–Ω—Å: <b>${(updatedUser.balance ?? 0).toLocaleString('ru-RU')}</b> –º–æ–Ω–µ—Ç
                  </div>
                  <button class="edit-balance-btn" data-id="${updatedUser.id}" data-balance="${(updatedUser.balance ?? 0).toLocaleString('ru-RU')}">üí≥ –ò–∑–º–µ–Ω–∏—Ç—å</button>
                `;
              }
            });
          }
  
        }
      }

      if (e.target.id === 'editModal') {
        e.target.style.display = 'none';
      }
    });
  </script>
<script>
  document.getElementById('newBalanceInput').addEventListener('input', function () {
    if (this.value.includes('-')) {
      this.value = this.value.replace('-', '');
    }
  });
</script>
<script>
const input = document.getElementById('newBalanceInput');

// –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—ë, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
input.addEventListener('keydown', function (e) {
  const allowedKeys = ['Backspace', 'ArrowLeft', 'ArrowRight', 'Tab', 'Delete'];
  if (!/^[0-9]$/.test(e.key) && !allowedKeys.includes(e.key)) {
    e.preventDefault();
  }
});

// –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä—ã –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ
input.addEventListener('input', function () {
  this.value = this.value.replace(/\D/g, '');
});
</script>
</body>
</html>

</html>
